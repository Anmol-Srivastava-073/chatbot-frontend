<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Veritas - Clinical Assistant</title>
Â  Â  <link rel="icon" type="image/png" href="image/veritasai.png" />
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  /* Base styles for a clean, modern look */
Â  Â  @import url('https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap');
Â  Â Â 
Â  Â  /* --- CUSTOM VERITAS THEME COLORS (Applied Directly) --- */
Â  Â  /* Primary Color: #006D77 */
Â  Â  .theme-primary-bg {
Â  Â  Â  Â  background-color: #006D77 !important;
Â  Â  }
Â  Â  /* Darker shade for hover effect on the Send button: #005B66 */
Â  Â  #send-button {
Â  Â  Â  Â  background-color: #006D77 !important;
Â  Â  Â  Â  transition: background-color 0.15s ease-in-out;
Â  Â  }
Â  Â  #send-button:hover {
Â  Â  Â  Â  background-color: #005B66 !important;Â 
Â  Â  }
Â  Â  /* --- NEW CHAT BUTTON STYLE --- */
Â  Â  #new-chat-button {
Â  Â  Â  Â  background-color: #005B66; /* Slightly darker primary */
Â  Â  Â  Â  transition: background-color 0.15s ease-in-out;
Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.3);
Â  Â  }
Â  Â  #new-chat-button:hover {
Â  Â  Â  Â  background-color: #004D55;
Â  Â  }
Â  Â  /* --- END CUSTOM COLORS --- */
Â  Â Â 
Â  Â  body {
Â  Â  Â  Â  font-family: 'Raleway', sans-serif;
Â  Â  Â  Â  background-color: #83C5BE !important; /* Light gray background */
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  margin: 0;
Â  Â  }
Â  Â  .chat-container {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  max-width: 700px; /* Slightly wider container */
Â  Â  Â  Â  height: 90vh;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  #chat-window {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  padding: 24px;
Â  Â  Â  Â  background-color: #f9fafb; /* Off-white chat area */
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 16px; /* Controls spacing BETWEEN messages */
Â  Â  }
Â  Â Â 
Â  Â  /* Message Bubble Styling - General */
Â  Â  .chat-bubble-container {
Â  Â  Â  Â  position: relative;Â 
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  max-width: 85%; /* Limits the ENTIRE container (icon + bubble) width */
Â  Â  }
Â  Â Â 
Â  Â  .chat-bubble {
Â  Â  Â  Â  padding: 12px 18px;
Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  line-height: 1.5;
Â  Â  }

Â  Â  /* Typing Indicator */
Â  Â  #typing-indicator {
Â  Â  Â  Â  align-self: flex-start;
Â  Â  Â  Â  color: #6b7280;
Â  Â  Â  Â  font-style: italic;
Â  Â  }

Â  Â  /* --- ICON INJECTION AND FINAL MESSAGE SIZING FIXES --- */

Â  Â  /* The user container needs to float to the right side of the chat window */
Â  Â  .user-container {
Â  Â  Â  Â  justify-content: flex-end; /* Aligns content (bubble and icon) to the right */
Â  Â  Â  Â  margin-left: auto; /* Pushes the entire container to the far right */
Â  Â  Â  Â  padding-right: 45px; /* Space for the icon */
Â  Â  Â  Â  flex-direction: row-reverse; /* Puts icon on the right of the bubble */
Â  Â  }

Â  Â  /* --- BOT STYLES (Icon on Left) --- */
Â  Â  .bot-container {
Â  Â  Â  Â  padding-left: 45px; /* Space for the icon */
Â  Â  }

Â  Â  .bot-container::before {
Â  Â  Â  Â  content: "";
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  left: 0;Â 
Â  Â  Â  Â  top: 50%;Â 
Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  width: 36px;
Â  Â  Â  Â  height: 36px;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  background-image: url('image/bot.png');Â 
Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  background-position: center;
Â  Â  Â  Â  background-color: #e0f2f7;
Â  Â  Â  Â  border: 2px solid #3f83f8;Â 
Â  Â  }

Â  Â  .bot-message {
Â  Â  Â  Â  width: 100%; /* Ensures full width usage within the container */
Â  Â  Â  Â  background-color: #e0f2f7;Â 
Â  Â  Â  Â  padding: 0.75rem 1rem;
Â  Â  Â  Â  border-radius: 1.25rem;
Â  Â  Â  Â  border-top-left-radius: 0.25rem;
Â  Â  Â  Â  color: #1f2937;Â 
Â  Â  Â  Â  border: 1px solid #d1d5db;Â 
Â  Â  }


Â  Â  /* --- USER STYLES (Icon on Right) --- */
Â  Â  .user-container::after {
Â  Â  Â  Â  content: "";
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  right: 0;Â 
Â  Â  Â  Â  top: 50%;Â 
Â  Â  Â  Â  transform: translateY(-50%);
Â  Â  Â  Â  width: 36px;
Â  Â  Â  Â  height: 36px;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  background-image: url('image/user.png');Â 
Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  background-position: center;
Â  Â  Â  Â  background-color: #d1fae5;
Â  Â  Â  Â  border: 2px solid #10b981;Â 
Â  Â  }

Â  Â  .user-message {
Â  Â  Â  Â  width: 100%; /* Ensures full width usage within the container */
Â  Â  Â  Â  background-color: #3b82f6;Â 
Â  Â  Â  Â  padding: 0.75rem 1rem;
Â  Â  Â  Â  border-radius: 1.25rem;
Â  Â  Â  Â  border-top-right-radius: 0.25rem;
Â  Â  Â  Â  color: white;Â 
Â  Â  }
Â  Â Â 
Â  Â  /* New: Microphone Button Styles */
Â  Â  #mic-button {
Â  Â  Â  Â  transition: background-color 0.15s ease-in-out;
Â  Â  }
Â  Â  .recording {
Â  Â  Â  Â  background-color: #ef4444 !important; /* Red-500 when recording */
Â  Â  Â  Â  animation: pulse-red 1s infinite;
Â  Â  }
Â  Â  @keyframes pulse-red {
Â  Â  Â  Â  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
Â  Â  Â  Â  70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
Â  Â  Â  Â  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
Â  Â  }
Â  Â  </style>
</head>
<body>

<div class="chat-container">
Â  Â  <header class="theme-primary-bg text-white p-4 shadow-lg flex justify-between items-center">Â 
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <h1 class="text-xl font-bold">âš•ï¸ Veritas - Clinical Assistant</h1>
Â  Â  Â  Â  Â  Â  <p class="text-sm opacity-80">Collecting Pre-Consultation Patient History</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  id="new-chat-button"Â 
Â  Â  Â  Â  Â  Â  class="text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-opacity-90 transition duration-150 ease-in-out"
Â  Â  Â  Â  Â  Â  title="Start a new conversation"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  New Chat
Â  Â  Â  Â  </button>
Â  Â  </header>

Â  Â  <div id="chat-window">
Â  Â  Â  Â  </div>

Â  Â  <div class="p-4 bg-white border-t flex flex-col gap-3">
Â  Â  Â  Â  <div id="typing-indicator" class="hidden text-sm text-gray-500">
Â  Â  Â  Â  Â  Â  <span class="inline-block h-3 w-3 bg-blue-500 rounded-full animate-pulse mr-2"></span>
Â  Â  Â  Â  Â  Â  Assistant is thinking...
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <form id="chat-form" class="flex">
Â  Â  Â  Â  Â  Â  <inputÂ 
Â  Â  Â  Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  Â  Â  Â  id="message-input"
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Enter your main symptom (e.g., Headache, Fever)..."Â 
Â  Â  Â  Â  Â  Â  Â  Â  class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
Â  Â  Â  Â  Â  Â  Â  Â  autocomplete="off"
Â  Â  Â  Â  Â  Â  Â  Â  required
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  type="button"
Â  Â  Â  Â  Â  Â  Â  Â  id="mic-button"
Â  Â  Â  Â  Â  Â  Â  Â  class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 shadow-md transition duration-150 ease-in-out disabled:opacity-50"
Â  Â  Â  Â  Â  Â  Â  Â  title="Start Voice Input"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M6 12.75a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 0 1-13.5 0v-1.5a.75.75 0 0 1 .75-.75Z" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  type="submit"
Â  Â  Â  Â  Â  Â  Â  Â  id="send-button"
Â  Â  Â  Â  Â  Â  Â  Â  class="text-white font-semibold py-3 px-6 rounded-r-xl shadow-md transition duration-150 ease-in-out disabled:opacity-50"Â 
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Send
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </form>
Â  Â  </div>
</div>

<script>
Â  Â  // Get DOM elements
Â  Â  const chatWindow = document.getElementById('chat-window');
Â  Â  const chatForm = document.getElementById('chat-form');
Â  Â  const messageInput = document.getElementById('message-input');
Â  Â  const typingIndicator = document.getElementById('typing-indicator');
Â  Â  const micButton = document.getElementById('mic-button');
Â  Â  const sendButton = document.getElementById('send-button');
Â  Â  // NEW: Get the New Chat button
Â  Â  const newChatButton = document.getElementById('new-chat-button');


Â  Â  // ---
Â  Â  // !!! IMPORTANT !!!
Â  Â  // This URL must be updated to your live Flask backend URL on Render.
Â  Â  // Replace the placeholder with your actual URL (e.g., https://your-app-name.onrender.com)
Â  Â  // ---
Â  Â  const API_BASE_URL = 'https://chatbot-78y3.onrender.com'; // <<< UPDATE THIS BASE URL

Â  Â  // --- User ID Management for Supabase Persistence ---
Â  Â  let USER_ID = localStorage.getItem('veritas_user_id');
Â  Â  if (!USER_ID) {
Â  Â  Â  Â  // Generate a new UUID if none exists
Â  Â  Â  Â  USER_ID = crypto.randomUUID();
Â  Â  Â  Â  localStorage.setItem('veritas_user_id', USER_ID);
Â  Â  Â  Â  console.log(`New user ID generated: ${USER_ID}`);
Â  Â  } else {
Â  Â  Â  Â  console.log(`Existing user ID loaded: ${USER_ID}`);
Â  Â  }

Â  Â  let conversation = [];

Â  Â  // ====================================================================
Â  Â  // ğŸ¤ VOICE INPUT SETUP (Web Speech API) - (Code omitted for brevity, assumed to work)
Â  Â  // ====================================================================

Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

Â  Â  if (SpeechRecognition) {
Â  Â  Â  Â  const recognition = new SpeechRecognition();
Â  Â  Â  Â  recognition.continuous = false;
Â  Â  Â  Â  recognition.lang = "en-US";
Â  Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  Â  recognition.maxAlternatives = 1;

Â  Â  Â  Â  micButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  recognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  micButton.classList.add('recording');
Â  Â  Â  Â  Â  Â  Â  Â  micButton.title = 'Recording... Speak now!';
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'ğŸ™ï¸ Recording... Please state your symptoms clearly.';Â 
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.disabled = true;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  if (error.name === 'InvalidStateError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error starting recognition:", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  Â  Â  Â  messageInput.value = transcript;
Â  Â  Â  Â  Â  Â  chatForm.dispatchEvent(new Event('submit'));
Â  Â  Â  Â  };

Â  Â  Â  Â  recognition.onend = () => {
Â  Â  Â  Â  Â  Â  micButton.classList.remove('recording');
Â  Â  Â  Â  Â  Â  micButton.title = 'Start Voice Input';
Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'Enter your main symptom (e.g., Headache, Fever)...';Â 
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  };

Â  Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  Â  Â  micButton.classList.remove('recording');
Â  Â  Â  Â  Â  Â  micButton.title = 'Start Voice Input';
Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'Enter your main symptom (e.g., Headache, Fever)...';Â 
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  console.error('Speech recognition error:', event.error);
Â  Â  Â  Â  };
Â  Â  } else {
Â  Â  Â  Â  micButton.style.display = 'none';
Â  Â  Â  Â  console.warn("Web Speech API is not supported in this browser.");
Â  Â  }


Â  Â  // ====================================================================
Â  Â  // ğŸ’¬ CHAT LOGIC AND STREAMING HANDLER
Â  Â  // ====================================================================

Â  Â  // Function to fetch history on load
Â  Â  async function getHistory() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_BASE_URL}/history`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ user_id: USER_ID })
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Failed to load history: ${response.status}`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data.history && Array.isArray(data.history) && data.history.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  conversation = data.history;
Â  Â  Â  Â  Â  Â  Â  Â  renderChatHistory();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Call the dedicated function for the initial message
Â  Â  Â  Â  Â  Â  Â  Â  fetchInitialMessage();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching history. Starting fresh chat:', error);
Â  Â  Â  Â  Â  Â  // FIX: Fallback to the dedicated function for the initial message
Â  Â  Â  Â  Â  Â  fetchInitialMessage();Â 
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // Function to render the entire history array to the DOM
Â  Â  function renderChatHistory() {
Â  Â  Â  Â  chatWindow.innerHTML = ''; // Clear existing messages
Â  Â  Â  Â  conversation.forEach(msg => {
Â  Â  Â  Â  Â  Â  const text = msg.parts ? msg.parts[0].text : msg.text; // Adapt to Flask output format
Â  Â  Â  Â  Â  Â  const sender = msg.role === 'model' ? 'bot' : 'user';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Re-render using addMessage function
Â  Â  Â  Â  Â  Â  addMessage(text, sender);
Â  Â  Â  Â  });
Â  Â  Â  Â  scrollToBottom();
Â  Â  }


Â  Â  // Function to handle the streaming API call and display
Â  Â  // REMOVED unused 'is_initial' argument from the signature
Â  Â  async function streamChat(message = null) {
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Prepare UI for streaming
Â  Â  Â  Â  showTypingIndicator();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Create the bot's receiving bubble and append it to the chat window
Â  Â  Â  Â  const botMessageContainer = document.createElement('div');
Â  Â  Â  Â  botMessageContainer.className = 'chat-bubble-container bot-container';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const botMessageBubble = document.createElement('div');
Â  Â  Â  Â  botMessageBubble.className = 'chat-bubble bot-message';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const botMessageText = document.createElement('p');
Â  Â  Â  Â  botMessageText.className = 'text-sm';
Â  Â  Â  Â  botMessageText.textContent = ''; // Start with empty content
Â  Â  Â  Â Â 
Â  Â  Â  Â  botMessageBubble.appendChild(botMessageText);
Â  Â  Â  Â  botMessageContainer.appendChild(botMessageBubble);
Â  Â  Â  Â  chatWindow.appendChild(botMessageContainer);
Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  // --- Stream execution ---
Â  Â  Â  Â  let fullReply = '';
Â  Â  Â  Â  const streamEndpoint = `${API_BASE_URL}/chat`;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(streamEndpoint, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  // Send the user ID and the message to the backend
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: USER_ID,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  message: message
Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Server Status ${response.status}: ${errorBody.substring(0, 200)}...`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Get the stream reader and decoder
Â  Â  Â  Â  Â  Â  const reader = response.body.getReader();
Â  Â  Â  Â  Â  Â  const decoder = new TextDecoder();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Loop to read the stream chunks
Â  Â  Â  Â  Â  Â  while (true) {
Â  Â  Â  Â  Â  Â  Â  Â  const { done, value } = await reader.read();
Â  Â  Â  Â  Â  Â  Â  Â  if (done) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Decode the chunk of text
Â  Â  Â  Â  Â  Â  Â  Â  const chunk = decoder.decode(value, { stream: true });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Append RAW text content for smooth streaming display
Â  Â  Â  Â  Â  Â  Â  Â  botMessageText.textContent += chunk;Â 
Â  Â  Â  Â  Â  Â  Â  Â  fullReply += chunk;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Keep the chat window scrolled to the bottom
Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 4. FINAL FIX: Convert markdown and apply to innerHTML once streaming is complete
Â  Â  Â  Â  Â  Â  botMessageText.innerHTML = convertMarkdownToHtml(fullReply);

Â  Â  Â  Â  Â  Â  // Fetch the updated history from the backend after the full exchange is done and saved
Â  Â  Â  Â  Â  Â  await getHistory();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching bot response:', error);
Â  Â  Â  Â  Â  Â  // Display the error message in the chat window
Â  Â  Â  Â  Â  Â  botMessageText.innerHTML = `âŒ Connection or Server Error: <strong>${error.message}</strong>. Please check console/logs.`;
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  // 6. Re-enable inputs
Â  Â  Â  Â  Â  Â  hideTypingIndicator();
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  micButton.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  messageInput.focus();
Â  Â  Â  Â  }
Â  Â  }


Â  Â  chatForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();Â 

Â  Â  Â  Â  const message = messageInput.value.trim();
Â  Â  Â  Â  if (message === '') return;Â 

Â  Â  Â  Â  // 1. Add user's message to the chat window (non-streaming)
Â  Â  Â  Â  addMessage(message, 'user');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Clear the input field and disable inputs
Â  Â  Â  Â  messageInput.value = '';
Â  Â  Â  Â  messageInput.disabled = true;
Â  Â  Â  Â  micButton.disabled = true;
Â  Â  Â  Â  sendButton.disabled = true;

Â  Â  Â  Â  // 3. Start the streaming process
Â  Â  Â  Â  await streamChat(message);
Â  Â  });

Â  Â  // --- NEW CHAT FUNCTIONALITY ---
Â  Â Â 
Â  Â  function startNewConversation() {
Â  Â  Â  Â  console.log("Starting new conversation, regenerating user ID.");
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Clear the DOM messages
Â  Â  Â  Â  chatWindow.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Reset the local conversation state
Â  Â  Â  Â  conversation = [];Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // FIX: Regenerate a brand new user ID for a fresh Supabase entry (Optional but ensures a clean slate)
Â  Â  Â  Â  USER_ID = crypto.randomUUID();
Â  Â  Â  Â  localStorage.setItem('veritas_user_id', USER_ID);
Â  Â  Â  Â  console.log(`New user ID generated for session: ${USER_ID}`);

Â  Â  Â  Â  // FIX: Call the dedicated function for the initial message
Â  Â  Â  Â  fetchInitialMessage();
Â  Â  }
Â  Â Â 
Â  Â  // Event listener for the new button
Â  Â  newChatButton.addEventListener('click', startNewConversation);
Â  Â  // --- END NEW CHAT FUNCTIONALITY ---


Â  Â  // --- Helper Functions ---
Â  Â Â 
Â  Â  function convertMarkdownToHtml(markdownText) {
Â  Â  Â  Â  let htmlText = markdownText;

Â  Â  Â  Â  // 1. Convert bold: **text** or __text__ to <strong>text</strong>
Â  Â  Â  Â  htmlText = htmlText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
Â  Â  Â  Â  htmlText = htmlText.replace(/__([^_]+)__/g, '<strong>$1</strong>');

Â  Â  Â  Â  // 2. Convert italics: *text* or _text_ to <em>text</em>
Â  Â  Â  Â  htmlText = htmlText.replace(/\*([^*]+)\*/g, '<em>$1</em>');
Â  Â  Â  Â  htmlText = htmlText.replace(/_([^_]+)_/g, '<em>$1</em>');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. Convert inline code: `code` to <code>code</code>
Â  Â  Â  Â  htmlText = htmlText.replace(/`([^`]+)`/g, '<code>$1</code>');

Â  Â  Â  Â  // 4. Convert newlines (\n) to <br> for proper line breaks
Â  Â  Â  Â  htmlText = htmlText.replace(/\n/g, '<br>');

Â  Â  Â  Â  return htmlText;
Â  Â  }

Â  Â  // *** NEW FUNCTION TO HANDLE THE NON-STREAMING INITIAL MESSAGE FETCH ***
async function fetchInitialMessage() {
Â  Â  try {
Â  Â  Â  Â  // Prepare UI
Â  Â  Â  Â  showTypingIndicator();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const response = await fetch(`${API_BASE_URL}/new_session`, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ user_id: USER_ID })
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`Failed to start new session: ${response.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Add the non-streaming initial bot message to the chat window
Â  Â  Â  Â  addMessage(data.message, 'bot');Â 
Â  Â  Â  Â Â 
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error starting new session:', error);
Â  Â  Â  Â  // Display error if the initial message fails
Â  Â  Â  Â  addMessage(`âŒ Error: Could not start new session. ${error.message}`, 'bot');
Â  Â  } finally {
Â  Â  Â  Â  // Re-enable input
Â  Â  Â  Â  hideTypingIndicator();
Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  micButton.disabled = false;
Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  messageInput.focus();
Â  Â  }
}


Â  Â  function addMessage(text, sender) {
Â  Â  Â  Â  const messageContainer = document.createElement('div');
Â  Â  Â  Â  messageContainer.className = `chat-bubble-container ${sender === 'user' ? 'user-container' : 'bot-container'}`;

Â  Â  Â  Â  const messageBubble = document.createElement('div');
Â  Â  Â  Â  messageBubble.className = `chat-bubble ${sender}-message`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const messageText = document.createElement('p');
Â  Â  Â  Â  messageText.className = 'text-sm';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (sender === 'bot') {
Â  Â  Â  Â  Â  Â  // Apply markdown conversion for messages
Â  Â  Â  Â  Â  Â  messageText.innerHTML = convertMarkdownToHtml(text);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Keep textContent for user messages to prevent HTML injection
Â  Â  Â  Â  Â  Â  messageText.textContent = text;
Â  Â  Â  Â  }

Â  Â  Â  Â  messageBubble.appendChild(messageText);
Â  Â  Â  Â  // Note: Icon is handled via CSS pseudo-elements
Â  Â  Â  Â  messageContainer.appendChild(messageBubble);Â 
Â  Â  Â  Â  chatWindow.appendChild(messageContainer);
Â  Â  Â  Â Â 
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  function scrollToBottom() {
Â  Â  Â  Â  chatWindow.scrollTop = chatWindow.scrollHeight;
Â  Â  }

Â  Â  function showTypingIndicator() {
Â  Â  Â  Â  typingIndicator.classList.remove('hidden');
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  function hideTypingIndicator() {
Â  Â  Â  Â  typingIndicator.classList.add('hidden');
Â  Â  }
Â  Â Â 
Â  Â  // --- INITIALIZATION ---
Â  Â  document.addEventListener('DOMContentLoaded', getHistory);
</script>
</body>
</html>
