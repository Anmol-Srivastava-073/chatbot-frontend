<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritas - Clinical Assistant</title>
    <link rel="icon" type="image/png" href="image/veritasai.png" />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Raleway:wght@300;500;700&display=swap');

        body {
            font-family: 'Raleway', sans-serif;
            background-color: #83C5BE;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .chat-container {
            width: 100%;
            max-width: 700px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        header {
            background-color: #006D77;
        }

        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-bubble-container {
            position: relative;
            display: flex;
            max-width: 85%;
        }

        .chat-bubble {
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .bot-container {
            padding-left: 45px;
        }

        .bot-container::before {
            content: "";
            left: 0;
            background-image: url("image/bot.png");
            background-size: cover;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .bot-message {
            background: #e0f2f7;
            border: 1px solid #d1d5db;
        }

        .user-container {
            justify-content: flex-end;
            margin-left: auto;
            padding-right: 45px;
        }

        .user-container::after {
            content: "";
            right: 0;
            background-image: url("image/user.png");
            background-size: cover;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }

        .user-message {
            background: #3b82f6;
            color: white;
        }

        #send-button {
            background-color: #006D77;
        }

        #send-button:hover {
            background-color: #005B66;
        }

        #typing-indicator {
            font-style: italic;
            color: gray;
        }

        .recording {
            background-color: red !important;
        }
    </style>
</head>

<body>

<div class="chat-container">

    <!-- HEADER -->
    <header class="text-white p-4 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">‚öïÔ∏è Veritas - Clinical Assistant</h1>
            <p class="text-sm opacity-80">Collecting Pre-Consultation Patient History</p>
        </div>

        <button id="new-chat-button"
            class="bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30">
            New Chat
        </button>
    </header>

    <!-- CHAT WINDOW -->
    <div id="chat-window"></div>

    <!-- INPUT AREA -->
    <div class="p-4 bg-white border-t flex flex-col gap-3">

        <div id="typing-indicator" class="hidden">
            Assistant is thinking...
        </div>

        <form id="chat-form" class="flex">
            <input id="message-input"
                type="text"
                placeholder="Enter your main symptom..."
                class="flex-grow p-3 border rounded-l-xl"
                required />

            <button type="button" id="mic-button"
                class="bg-gray-400 text-white px-4">
                üé§
            </button>

            <button type="submit" id="send-button"
                class="text-white px-6 rounded-r-xl">
                Send
            </button>
        </form>
    </div>

</div>


<script>
/* ======================================================
   CONFIG
====================================================== */

const chatWindow = document.getElementById("chat-window");
const chatForm = document.getElementById("chat-form");
const messageInput = document.getElementById("message-input");
const typingIndicator = document.getElementById("typing-indicator");
const newChatButton = document.getElementById("new-chat-button");

const micButton = document.getElementById("mic-button");
const sendButton = document.getElementById("send-button");

/* ‚úÖ CHANGE THIS TO YOUR BACKEND */
const API_BASE_URL = "https://chatbot-78y3.onrender.com";

/* ======================================================
   USER ID PERSISTENCE
====================================================== */

let USER_ID = localStorage.getItem("veritas_user_id");

if (!USER_ID) {
    USER_ID = crypto.randomUUID();
    localStorage.setItem("veritas_user_id", USER_ID);
}

/* ======================================================
   HELPERS
====================================================== */

function scrollToBottom() {
    chatWindow.scrollTop = chatWindow.scrollHeight;
}

function showTyping() {
    typingIndicator.classList.remove("hidden");
}

function hideTyping() {
    typingIndicator.classList.add("hidden");
}

function addMessage(text, sender) {

    const container = document.createElement("div");
    container.className =
        `chat-bubble-container ${sender === "user" ? "user-container" : "bot-container"}`;

    const bubble = document.createElement("div");
    bubble.className =
        `chat-bubble ${sender === "user" ? "user-message" : "bot-message"}`;

    bubble.innerHTML = text.replace(/\n/g, "<br>");

    container.appendChild(bubble);
    chatWindow.appendChild(container);

    scrollToBottom();
}

/* ======================================================
   FETCH INITIAL BOT MESSAGE
====================================================== */

async function fetchInitialMessage() {

    showTyping();

    const response = await fetch(`${API_BASE_URL}/new_session`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: USER_ID })
    });

    const data = await response.json();
    addMessage(data.message, "bot");

    hideTyping();
}

/* ======================================================
   LOAD HISTORY
====================================================== */

async function getHistory() {

    const response = await fetch(`${API_BASE_URL}/history`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: USER_ID })
    });

    const data = await response.json();

    if (!data.history || data.history.length === 0) {
        fetchInitialMessage();
        return;
    }

    chatWindow.innerHTML = "";

    data.history.forEach(msg => {
        const sender = msg.role === "user" ? "user" : "bot";
        addMessage(msg.text, sender);
    });
}

/* ======================================================
   MAIN CHAT SEND (NON STREAMING FIX)
====================================================== */

async function sendChat(message) {

    showTyping();

    const response = await fetch(`${API_BASE_URL}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            user_id: USER_ID,
            message: message
        })
    });

    const data = await response.json();

    addMessage(data.message, "bot");

    hideTyping();
}

/* ======================================================
   FORM SUBMIT
====================================================== */

chatForm.addEventListener("submit", async (e) => {

    e.preventDefault();

    const msg = messageInput.value.trim();
    if (!msg) return;

    addMessage(msg, "user");

    messageInput.value = "";

    await sendChat(msg);
});

/* ======================================================
   NEW CHAT BUTTON
====================================================== */

newChatButton.addEventListener("click", () => {

    chatWindow.innerHTML = "";

    USER_ID = crypto.randomUUID();
    localStorage.setItem("veritas_user_id", USER_ID);

    fetchInitialMessage();
});

/* ======================================================
   INIT
====================================================== */

document.addEventListener("DOMContentLoaded", getHistory);

</script>

</body>
</html>
