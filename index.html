<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Research Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .chat-container {
            width: 100%;
            max-width: 700px; /* Slightly wider container */
            height: 90vh;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        #chat-window {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: #f9fafb; /* Off-white chat area */
            display: flex;
            flex-direction: column;
            gap: 16px; /* Increased spacing between messages */
        }
        
        /* Message Bubble Styling */
        .chat-bubble-container {
            display: flex;
            max-width: 100%;
        }
        .chat-bubble {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            word-wrap: break-word;
            line-height: 1.5;
        }

        /* User Message */
        .user-container {
            justify-content: flex-end;
        }
        .user-message {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            border-top-right-radius: 4px; /* Slight square corner on the inside */
        }

        /* Bot Message */
        .bot-container {
            justify-content: flex-start;
        }
        .bot-message {
            background-color: #ffffff; 
            color: #1f2937; /* Dark text */
            border: 1px solid #d1d5db; /* Light gray border */
            border-top-left-radius: 4px; /* Slight square corner on the inside */
            white-space: pre-wrap; /* Essential for streaming, handles newlines */
        }

        /* Typing Indicator */
        #typing-indicator {
            align-self: flex-start;
            color: #6b7280;
            font-style: italic;
        }

        /* New: Microphone Button Styles */
        #mic-button {
            transition: background-color 0.15s ease-in-out;
        }
        .recording {
            background-color: #ef4444 !important; /* Red-500 when recording */
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>

<div class="chat-container">
    <header class="bg-gray-800 text-white p-4 shadow-lg">
        <h1 class="text-xl font-bold">ğŸ”¬ Gemini Research Assistant</h1>
        <p class="text-sm opacity-80">Powered by Gemini 2.5 Pro for deep analysis</p>
    </header>

    <div id="chat-window">
        <div class="chat-bubble-container bot-container">
            <div class="chat-bubble bot-message">
                <p class="text-sm">Hello! I'm your research assistant powered by Gemini 2.5 Pro. I'm ready for complex queries, code analysis, or anything requiring factual depth. How can I help you research today?</p>
            </div>
        </div>
        </div>

    <div class="p-4 bg-white border-t flex flex-col gap-3">
        <div id="typing-indicator" class="hidden text-sm text-gray-500">
            <span class="inline-block h-3 w-3 bg-blue-500 rounded-full animate-pulse mr-2"></span>
            Assistant is thinking...
        </div>
        <form id="chat-form" class="flex">
            <input 
                type="text"
                id="message-input"
                placeholder="Ask your research question..."
                class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
                autocomplete="off"
                required
            />
            <button
                type="button"
                id="mic-button"
                class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 shadow-md transition duration-150 ease-in-out disabled:opacity-50"
                title="Start Voice Input"
            >
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                    <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" />
                    <path d="M6 12.75a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 0 1-13.5 0v-1.5a.75.75 0 0 1 .75-.75Z" />
                </svg>
            </button>
            <button
                type="submit"
                id="send-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-r-xl shadow-md transition duration-150 ease-in-out disabled:opacity-50"
            >
                Send
            </button>
        </form>
    </div>
</div>

<script>
Â  Â  // Get DOM elements
Â  Â  const chatWindow = document.getElementById('chat-window');
Â  Â  const chatForm = document.getElementById('chat-form');
Â  Â  const messageInput = document.getElementById('message-input');
Â  Â  const typingIndicator = document.getElementById('typing-indicator');
Â  Â  const micButton = document.getElementById('mic-button');
Â  Â  const sendButton = document.getElementById('send-button');

Â  Â  // ---
Â  Â  // !!! IMPORTANT !!!
Â  Â  // PASTE YOUR RENDER BACKEND URL HERE: The URL must look like: https://[your-app-name].onrender.com/chat
Â  Â  // ---
Â  Â  const API_URL = 'https://chatbot-78y3.onrender.com/chat'; // <--- REPLACE THIS ENTIRE STRING WITH YOUR REAL PUBLIC URL + /chat

Â  Â  // --- Store conversation history ---
Â  Â  let conversation = [];

Â  Â  // ====================================================================
Â  Â  // ğŸ¤ VOICE INPUT SETUP (Web Speech API)
Â  Â  // ====================================================================

Â  Â  // Get the vendor-prefixed SpeechRecognition object
Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

Â  Â  // Check if the browser supports Speech Recognition
Â  Â  if (SpeechRecognition) {
Â  Â  Â  Â  const recognition = new SpeechRecognition();
Â  Â  Â  Â  recognition.continuous = false; // Stop listening after one phrase
Â  Â  Â  Â  recognition.lang = "en-US"; // Set your language here
Â  Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  Â  recognition.maxAlternatives = 1;

Â  Â  Â  Â  // Event for when the mic button is clicked
Â  Â  Â  Â  micButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  recognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  micButton.classList.add('recording');
Â  Â  Â  Â  Â  Â  Â  Â  micButton.title = 'Recording... Speak now!';
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'ğŸ™ï¸ Recording... Speak now!';
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Voice recognition started.");
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Catches error if recognition is already active
Â  Â  Â  Â  Â  Â  Â  Â  if (error.name === 'InvalidStateError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â recognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error starting recognition:", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Event for when a result is successfully recognized
Â  Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  Â  Â  Â  console.log("Transcript received:", transcript);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set the transcript into the text input
Â  Â  Â  Â  Â  Â  messageInput.value = transcript;

Â  Â  Â  Â  Â  Â  // Trigger the form submission using the transcribed text
Â  Â  Â  Â  Â  Â  chatForm.dispatchEvent(new Event('submit'));
Â  Â  Â  Â  };

Â  Â  Â  Â  // Event for when the recognition service disconnects or stops
Â  Â  Â  Â  recognition.onend = () => {
Â  Â  Â  Â  Â  Â  micButton.classList.remove('recording');
Â  Â  Â  Â  Â  Â  micButton.title = 'Start Voice Input';
Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'Ask your research question...';
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  console.log("Voice recognition ended.");
Â  Â  Â  Â  };

Â  Â  Â  Â  // Event for errors (e.g., no microphone found, permission denied)
Â  Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  Â  Â  micButton.classList.remove('recording');
Â  Â  Â  Â  Â  Â  micButton.title = 'Start Voice Input';
Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'Ask your research question...';
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  console.error('Speech recognition error:', event.error);
Â  Â  Â  Â  Â  Â  // Optionally alert the user
Â  Â  Â  Â  Â  Â  if (event.error === 'not-allowed') {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Microphone permission denied. Please allow microphone access for voice input.");
Â  Â  Â  Â  Â  Â  } else if (event.error === 'no-speech') {
Â  Â  Â  Â  Â  Â  Â  Â  alert("No speech detected. Please try speaking louder.");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Voice input error: ${event.error}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  } else {
Â  Â  Â  Â  // Hide the mic button if the browser doesn't support the API
Â  Â  Â  Â  micButton.style.display = 'none';
Â  Â  Â  Â  console.warn("Web Speech API is not supported in this browser.");
Â  Â  }

Â  Â  // ====================================================================
Â  Â  // ğŸ’¬ CHAT LOGIC 
Â  Â  // ====================================================================
Â  Â Â 
Â  Â  chatForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();Â 

Â  Â  Â  Â  const message = messageInput.value.trim();
Â  Â  Â  Â  if (message === '') return;Â 

Â  Â  Â  Â  // 1. Add user's message to the chat window and history
Â  Â  Â  Â  addMessage(message, 'user');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Add user input to local history immediately
Â  Â  Â  Â  conversation.push({ "role": "user", "parts": [{ "text": message }] });

Â  Â  Â  Â  // Clear the input field and disable
Â  Â  Â  Â  messageInput.value = '';
Â  Â  Â  Â  messageInput.disabled = true;
Â  Â  Â  Â  micButton.disabled = true;
Â  Â  Â  Â  sendButton.disabled = true;

Â  Â  Â  Â  // 2. Prepare the bot's receiving bubble
Â  Â  Â  Â  const botMessageContainer = document.createElement('div');
Â  Â  Â  Â  botMessageContainer.className = 'chat-bubble-container bot-container';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const botMessageBubble = document.createElement('div');
Â  Â  Â  Â  botMessageBubble.className = 'chat-bubble bot-message';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const botMessageText = document.createElement('p');
Â  Â  Â  Â  botMessageText.className = 'text-sm';
Â  Â  Â  Â Â 
Â  Â  Â  Â  botMessageBubble.appendChild(botMessageText);
Â  Â  Â  Â  botMessageContainer.appendChild(botMessageBubble);
Â  Â  Â  Â  chatWindow.appendChild(botMessageContainer);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Show typing indicator
Â  Â  Â  Â  showTypingIndicator();
Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  // --- STREAMING LOGIC ---
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(API_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Only send the 'history' array as expected by the Flask backend
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history: conversation,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // The 'message: message' line was removed here.
Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // Better error handling for non-200 responses
Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Server status ${response.status}: ${errorBody.substring(0, 100)}...`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Get the stream reader and decoder
Â  Â  Â  Â  Â  Â  const reader = response.body.getReader();
Â  Â  Â  Â  Â  Â  const decoder = new TextDecoder();
Â  Â  Â  Â  Â  Â  let fullReply = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Loop to read the stream chunks
Â  Â  Â  Â  Â  Â  while (true) {
Â  Â  Â  Â  Â  Â  Â  Â  const { done, value } = await reader.read();
Â  Â  Â  Â  Â  Â  Â  Â  if (done) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Decode the chunk of text
Â  Â  Â  Â  Â  Â  Â  Â  const chunk = decoder.decode(value, { stream: true });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Append the new text to the bot's message element and use markdown conversion
Â  Â  Â  Â  Â  Â  Â  Â  botMessageText.innerHTML += convertMarkdownToHtml(chunk);
Â  Â  Â  Â  Â  Â  Â  Â  fullReply += chunk;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Keep the chat window scrolled to the bottom
Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Complete the turn
Â  Â  Â  Â  Â  Â  hideTypingIndicator();
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  micButton.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  messageInput.focus();

Â  Â  Â  Â  Â  Â  // Add the *full* final reply to the conversation history for the next turn
Â  Â  Â  Â  Â  Â  conversation.push({ "role": "model", "parts": [{ "text": fullReply }] });
            
            // Set the final, fully converted HTML content for coherence
            botMessageText.innerHTML = convertMarkdownToHtml(fullReply);


Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching bot response:', error);
Â  Â  Â  Â  Â  Â  hideTypingIndicator();
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  micButton.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Display the error message in the chat window
Â  Â  Â  Â  Â  Â  botMessageText.textContent = `âŒ Connection or Server Error: ${error.message}. Please check console/logs.`;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- Helper Functions ---
    
    // NEW: Function to convert basic markdown (like bold and newlines) to HTML
    function convertMarkdownToHtml(markdownText) {
        let htmlText = markdownText;

        // 1. Convert bold: **text** or __text__ to <strong>text</strong>
        htmlText = htmlText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        htmlText = htmlText.replace(/__([^_]+)__/g, '<strong>$1</strong>');

        // 2. Convert italics: *text* or _text_ to <em>text</em>
        htmlText = htmlText.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        htmlText = htmlText.replace(/_([^_]+)_/g, '<em>$1</em>');
        
        // 3. Convert inline code: `code` to <code>code</code>
        htmlText = htmlText.replace(/`([^`]+)`/g, '<code>$1</code>');

        // 4. Convert newlines (\n) to <br> for proper line breaks
        htmlText = htmlText.replace(/\n/g, '<br>');

        return htmlText;
    }


Â  Â  function addMessage(text, sender) {
Â  Â  Â  Â  // This function is now only used for the initial bot message and user messages
Â  Â  Â  Â  const messageContainer = document.createElement('div');
Â  Â  Â  Â  messageContainer.className = `chat-bubble-container ${sender === 'user' ? 'user-container' : 'bot-container'}`;

Â  Â  Â  Â  const messageBubble = document.createElement('div');
Â  Â  Â  Â  messageBubble.className = `chat-bubble ${sender}-message`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const messageText = document.createElement('p');
Â  Â  Â  Â  messageText.className = 'text-sm';
Â  Â  Â  Â  
        // MODIFIED: Use innerHTML and the converter for bot messages
        if (sender === 'bot') {
            messageText.innerHTML = convertMarkdownToHtml(text);
        } else {
            // Keep textContent for user messages to prevent HTML injection
            messageText.textContent = text;
        }


Â  Â  Â  Â  messageBubble.appendChild(messageText);
Â  Â  Â  Â  messageContainer.appendChild(messageBubble);
Â  Â  Â  Â  chatWindow.appendChild(messageContainer);
Â  Â  Â  Â Â 
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  function scrollToBottom() {
Â  Â  Â  Â  chatWindow.scrollTop = chatWindow.scrollHeight;
Â  Â  }

Â  Â  function showTypingIndicator() {
Â  Â  Â  Â  typingIndicator.classList.remove('hidden');
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  function hideTypingIndicator() {
Â  Â  Â  Â  typingIndicator.classList.add('hidden');
Â  Â  }
</script>
</body>
</html>
