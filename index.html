<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Gemini Research Chatbot</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Base styles for a clean, modern look */
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #e5e7eb; /* Light gray background */
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 700px; /* Slightly wider container */
Â  Â  Â  Â  Â  Â  height: 90vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  Â  Â  border-radius: 16px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  #chat-window {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  padding: 24px;
Â  Â  Â  Â  Â  Â  background-color: #f9fafb; /* Off-white chat area */
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 16px; /* Increased spacing between messages */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Message Bubble Styling */
Â  Â  Â  Â  .chat-bubble-container {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-bubble {
Â  Â  Â  Â  Â  Â  max-width: 85%;
Â  Â  Â  Â  Â  Â  padding: 12px 18px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* User Message */
Â  Â  Â  Â  .user-container {
Â  Â  Â  Â  Â  Â  justify-content: flex-end;
Â  Â  Â  Â  }
Â  Â  Â  Â  .user-message {
Â  Â  Â  Â  Â  Â  background-color: #3b82f6; /* Blue-500 */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border-top-right-radius: 4px; /* Slight square corner on the inside */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Bot Message */
Â  Â  Â  Â  .bot-container {
Â  Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  }
Â  Â  Â  Â  .bot-message {
Â  Â  Â  Â  Â  Â  background-color: #ffffff;Â 
Â  Â  Â  Â  Â  Â  color: #1f2937; /* Dark text */
Â  Â  Â  Â  Â  Â  border: 1px solid #d1d5db; /* Light gray border */
Â  Â  Â  Â  Â  Â  border-top-left-radius: 4px; /* Slight square corner on the inside */
Â  Â  Â  Â  Â  Â  white-space: pre-wrap; /* Essential for streaming, handles newlines */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Typing Indicator */
Â  Â  Â  Â  #typing-indicator {
Â  Â  Â  Â  Â  Â  align-self: flex-start;
Â  Â  Â  Â  Â  Â  color: #6b7280;
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Reverting markdown code block style for light theme contrast */
        .bot-message code {
            background-color: #f1f5f9; /* Light gray background for inline code */
            color: #1f2937;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid #e2e8f0;
        }

Â  Â  Â  Â  /* New: Microphone Button Styles */
Â  Â  Â  Â  #mic-button {
Â  Â  Â  Â  Â  Â  transition: background-color 0.15s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .recording {
Â  Â  Â  Â  Â  Â  background-color: #ef4444 !important; /* Red-500 when recording */
Â  Â  Â  Â  Â  Â  animation: pulse-red 1s infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes pulse-red {
Â  Â  Â  Â  Â  Â  0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
Â  Â  Â  Â  Â  Â  70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
Â  Â  Â  Â  Â  Â  100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div class="chat-container">
Â  Â  <header class="bg-gray-800 text-white p-4 shadow-lg">
Â  Â  Â  Â  <h1 class="text-xl font-bold">ğŸ”¬ Gemini Research Assistant</h1>
Â  Â  Â  Â  <p class="text-sm opacity-80">Powered by Gemini 2.5 Pro for deep analysis</p>
Â  Â  </header>

Â  Â  <div id="chat-window">
Â  Â  Â  Â  <div class="chat-bubble-container bot-container">
Â  Â  Â  Â  Â  Â  <div class="chat-bubble bot-message">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm">Hello! I'm your research assistant powered by Gemini 2.5 Pro. I'm ready for complex queries, code analysis, or anything requiring factual depth. How can I help you research today?</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  <div class="p-4 bg-white border-t flex flex-col gap-3">
Â  Â  Â  Â  <div id="typing-indicator" class="hidden text-sm text-gray-500">
Â  Â  Â  Â  Â  Â  <span class="inline-block h-3 w-3 bg-blue-500 rounded-full animate-pulse mr-2"></span>
Â  Â  Â  Â  Â  Â  Assistant is thinking...
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <form id="chat-form" class="flex">
Â  Â  Â  Â  Â  Â  <inputÂ 
Â  Â  Â  Â  Â  Â  Â  Â  type="text"
Â  Â  Â  Â  Â  Â  Â  Â  id="message-input"
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Ask your research question..."
Â  Â  Â  Â  Â  Â  Â  Â  class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800"
Â  Â  Â  Â  Â  Â  Â  Â  autocomplete="off"
Â  Â  Â  Â  Â  Â  Â  Â  required
Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  type="button"
Â  Â  Â  Â  Â  Â  Â  Â  id="mic-button"
Â  Â  Â  Â  Â  Â  Â  Â  class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-4 shadow-md transition duration-150 ease-in-out disabled:opacity-50"
Â  Â  Â  Â  Â  Â  Â  Â  title="Start Voice Input"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M8.25 4.5a3.75 3.75 0 1 1 7.5 0v8.25a3.75 3.75 0 1 1-7.5 0V4.5Z" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M6 12.75a.75.75 0 0 1 .75.75v1.5a5.25 5.25 0 1 0 10.5 0v-1.5a.75.75 0 0 1 1.5 0v1.5a6.75 6.75 0 0 1-13.5 0v-1.5a.75.75 0 0 1 .75-.75Z" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  type="submit"
Â  Â  Â  Â  Â  Â  Â  Â  id="send-button"
Â  Â  Â  Â  Â  Â  Â  Â  class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-r-xl shadow-md transition duration-150 ease-in-out disabled:opacity-50"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Send
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </form>
Â  Â  </div>
</div>

<script>
Â  Â  // Get DOM elements
Â  Â  const chatWindow = document.getElementById('chat-window');
Â  Â  const chatForm = document.getElementById('chat-form');
Â  Â  const messageInput = document.getElementById('message-input');
Â  Â  const typingIndicator = document.getElementById('typing-indicator');
Â  Â  const micButton = document.getElementById('mic-button');
Â  Â  const sendButton = document.getElementById('send-button');

Â  Â  // ---
Â  Â  // !!! IMPORTANT !!!
Â  Â  // PASTE YOUR RENDER BACKEND URL HERE: The URL must look like: https://[your-app-name].onrender.com/chat
Â  Â  // ---
Â  Â  const API_URL = 'https://chatbot-78y3.onrender.com/chat'; // <--- REPLACE THIS ENTIRE STRING WITH YOUR REAL PUBLIC URL + /chat

Â  Â  // --- Store conversation history ---
Â  Â  let conversation = [];

Â  Â  // ====================================================================
Â  Â  // ğŸ¤ VOICE INPUT SETUP (Web Speech API)
Â  Â  // ====================================================================

Â  Â  // Get the vendor-prefixed SpeechRecognition object
Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

Â  Â  // Check if the browser supports Speech Recognition
Â  Â  if (SpeechRecognition) {
Â  Â  Â  Â  const recognition = new SpeechRecognition();
Â  Â  Â  Â  recognition.continuous = false; // Stop listening after one phrase
Â  Â  Â  Â  recognition.lang = "en-US"; // Set your language here
Â  Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  Â  recognition.maxAlternatives = 1;

Â  Â  Â  Â  // Event for when the mic button is clicked
Â  Â  Â  Â  micButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  recognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  micButton.classList.add('recording');
Â  Â  Â  Â  Â  Â  Â  Â  micButton.title = 'Recording... Speak now!';
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'ğŸ™ï¸ Recording... Speak now!';
Â  Â  Â  Â  Â  Â  Â  Â  messageInput.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Voice recognition started.");
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  // Catches error if recognition is already active
Â  Â  Â  Â  Â  Â  Â  Â  if (error.name === 'InvalidStateError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â recognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error starting recognition:", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Event for when a result is successfully recognized
Â  Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  Â  Â  Â  console.log("Transcript received:", transcript);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set the transcript into the text input
Â  Â  Â  Â  Â  Â  messageInput.value = transcript;

Â  Â  Â  Â  Â  Â  // Trigger the form submission using the transcribed text
Â  Â  Â  Â  Â  Â  chatForm.dispatchEvent(new Event('submit'));
Â  Â  Â  Â  };

Â  Â  Â  Â  // Event for when the recognition service disconnects or stops
Â  Â  Â  Â  recognition.onend = () => {
Â  Â  Â  Â  Â  Â  micButton.classList.remove('recording');
Â  Â  Â  Â  Â  Â  micButton.title = 'Start Voice Input';
Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'Ask your research question...';
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  console.log("Voice recognition ended.");
Â  Â  Â  Â  };

Â  Â  Â  Â  // Event for errors (e.g., no microphone found, permission denied)
Â  Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  Â  Â  micButton.classList.remove('recording');
Â  Â  Â  Â  Â  Â  micButton.title = 'Start Voice Input';
Â  Â  Â  Â  Â  Â  messageInput.placeholder = 'Ask your research question...';
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  console.error('Speech recognition error:', event.error);
Â  Â  Â  Â  Â  Â  // Optionally alert the user
Â  Â  Â  Â  Â  Â  if (event.error === 'not-allowed') {
Â  Â  Â  Â  Â  Â  Â  Â  // Using console.error instead of alert due to constraints
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Microphone permission denied. Please allow microphone access for voice input.");
Â  Â  Â  Â  Â  Â  } else if (event.error === 'no-speech') {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("No speech detected. Please try speaking louder.");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Voice input error: ${event.error}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  } else {
Â  Â  Â  Â  // Hide the mic button if the browser doesn't support the API
Â  Â  Â  Â  micButton.style.display = 'none';
Â  Â  Â  Â  console.warn("Web Speech API is not supported in this browser.");
Â  Â  }

Â  Â  // ====================================================================
Â  Â  // ğŸ’¬ CHAT LOGICÂ 
Â  Â  // ====================================================================
Â  Â Â 
Â  Â  chatForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();Â 

Â  Â  Â  Â  const message = messageInput.value.trim();
Â  Â  Â  Â  if (message === '') return;Â 

Â  Â  Â  Â  // 1. Add user's message to the chat window and history
Â  Â  Â  Â  addMessage(message, 'user');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Add user input to local history immediately
Â  Â  Â  Â  conversation.push({ "role": "user", "parts": [{ "text": message }] });

Â  Â  Â  Â  // Clear the input field and disable
Â  Â  Â  Â  messageInput.value = '';
Â  Â  Â  Â  messageInput.disabled = true;
Â  Â  Â  Â  micButton.disabled = true;
Â  Â  Â  Â  sendButton.disabled = true;

Â  Â  Â  Â  // 2. Prepare the bot's receiving bubble
Â  Â  Â  Â  const botMessageContainer = document.createElement('div');
Â  Â  Â  Â  botMessageContainer.className = 'chat-bubble-container bot-container';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const botMessageBubble = document.createElement('div');
Â  Â  Â  Â  botMessageBubble.className = 'chat-bubble bot-message';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const botMessageText = document.createElement('p');
Â  Â  Â  Â  botMessageText.className = 'text-sm';
Â  Â  Â  Â Â 
Â  Â  Â  Â  botMessageBubble.appendChild(botMessageText);
Â  Â  Â  Â  botMessageContainer.appendChild(botMessageBubble);
Â  Â  Â  Â  chatWindow.appendChild(botMessageContainer);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Show typing indicator
Â  Â  Â  Â  showTypingIndicator();
Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  // --- STREAMING LOGIC ---
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(API_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Only send the 'history' array as expected by the Flask backend
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history: conversation,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // The 'message: message' line was removed here.
Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // Better error handling for non-200 responses
Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Server status ${response.status}: ${errorBody.substring(0, 100)}...`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Get the stream reader and decoder
Â  Â  Â  Â  Â  Â  const reader = response.body.getReader();
Â  Â  Â  Â  Â  Â  const decoder = new TextDecoder();
Â  Â  Â  Â  Â  Â  let fullReply = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Loop to read the stream chunks
Â  Â  Â  Â  Â  Â  while (true) {
Â  Â  Â  Â  Â  Â  Â  Â  const { done, value } = await reader.read();
Â  Â  Â  Â  Â  Â  Â  Â  if (done) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Decode the chunk of text
Â  Â  Â  Â  Â  Â  Â  Â  const chunk = decoder.decode(value, { stream: true });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Append the new text to the bot's message element and use markdown conversion
Â  Â  Â  Â  Â  Â  Â  Â  botMessageText.innerHTML += convertMarkdownToHtml(chunk);
Â  Â  Â  Â  Â  Â  Â  Â  fullReply += chunk;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Keep the chat window scrolled to the bottom
Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Complete the turn
Â  Â  Â  Â  Â  Â  hideTypingIndicator();
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  micButton.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  messageInput.focus();

Â  Â  Â  Â  Â  Â  // Add the *full* final reply to the conversation history for the next turn
Â  Â  Â  Â  Â  Â  conversation.push({ "role": "model", "parts": [{ "text": fullReply }] });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set the final, fully converted HTML content for coherence
Â  Â  Â  Â  Â  Â  botMessageText.innerHTML = convertMarkdownToHtml(fullReply);


Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching bot response:', error);
Â  Â  Â  Â  Â  Â  hideTypingIndicator();
Â  Â  Â  Â  Â  Â  messageInput.disabled = false;
Â  Â  Â  Â  Â  Â  micButton.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Display the error message in the chat window
Â  Â  Â  Â  Â  Â  console.error(`âŒ Connection or Server Error: ${error.message}. Please check console/logs.`);
            botMessageText.innerHTML = 'âŒ System Error. Check the console for details.';
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- Helper Functions ---
Â  Â Â 
Â  Â  // NEW: Function to convert basic markdown (like bold and newlines) to HTML
Â  Â  function convertMarkdownToHtml(markdownText) {
Â  Â  Â  Â  let htmlText = markdownText;

Â  Â  Â  Â  // 1. Convert bold: **text** or __text__ to <strong>text</strong>
Â  Â  Â  Â  htmlText = htmlText.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
Â  Â  Â  Â  htmlText = htmlText.replace(/__([^_]+)__/g, '<strong>$1</strong>');

Â  Â  Â  Â  // 2. Convert italics: *text* or _text_ to <em>text</em>
Â  Â  Â  Â  htmlText = htmlText.replace(/\*([^*]+)\*/g, '<em>$1</em>');
Â  Â  Â  Â  htmlText = htmlText.replace(/_([^_]+)_/g, '<em>$1</em>');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. Convert inline code: `code` to <code>code</code>
Â  Â  Â  Â  htmlText = htmlText.replace(/`([^`]+)`/g, '<code>$1</code>');

Â  Â  Â  Â  // 4. Convert newlines (\n) to <br> for proper line breaks
Â  Â  Â  Â  htmlText = htmlText.replace(/\n/g, '<br>');

Â  Â  Â  Â  return htmlText;
Â  Â  }


Â  Â  function addMessage(text, sender) {
Â  Â  Â  Â  // This function is now only used for the initial bot message and user messages
Â  Â  Â  Â  const messageContainer = document.createElement('div');
Â  Â  Â  Â  messageContainer.className = `chat-bubble-container ${sender === 'user' ? 'user-container' : 'bot-container'}`;

Â  Â  Â  Â  const messageBubble = document.createElement('div');
Â  Â  Â  Â  messageBubble.className = `chat-bubble ${sender}-message`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const messageText = document.createElement('p');
Â  Â  Â  Â  messageText.className = 'text-sm';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // MODIFIED: Use innerHTML and the converter for bot messages
Â  Â  Â  Â  if (sender === 'bot') {
Â  Â  Â  Â  Â  Â  messageText.innerHTML = convertMarkdownToHtml(text);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Keep textContent for user messages to prevent HTML injection
Â  Â  Â  Â  Â  Â  messageText.textContent = text;
Â  Â  Â  Â  }


Â  Â  Â  Â  messageBubble.appendChild(messageText);
Â  Â  Â  Â  messageContainer.appendChild(messageBubble);
Â  Â  Â  Â  chatWindow.appendChild(messageContainer);
Â  Â  Â  Â Â 
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  function scrollToBottom() {
Â  Â  Â  Â  chatWindow.scrollTop = chatWindow.scrollHeight;
Â  Â  }

Â  Â  function showTypingIndicator() {
Â  Â  Â  Â  typingIndicator.classList.remove('hidden');
Â  Â  Â  Â  scrollToBottom();
Â  Â  }

Â  Â  function hideTypingIndicator() {
Â  Â  Â  Â  typingIndicator.classList.add('hidden');
Â  Â  }
</script>
</body>
</html>
